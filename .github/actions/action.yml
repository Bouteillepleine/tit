name: 'Build OnePlus Kernel with SukiSU Ultra'

inputs:
  op_config_json:
    description: 'JSON string containing full device config (model, soc, branch, manifest)'
    required: true
  ksu_meta:
    description: 'SukiSU Ultra metadata in format: branch/custom_tag/commit_hash'
    required: false
    default: 'susfs-main/‚ö°Ultra‚ö°/'
  lsm:
    description: 'Enable Baseband Guard LSM security module'
    required: false
    default: 'false'
  enable_zram:
    description: 'Enable ZRAM with advanced compressors (LZ4K, LZ4KD, etc.)'
    required: false
    default: 'false'
  sched:
    description: 'Enable Fengchi scheduler (6.6 kernels only)'
    required: false
    default: 'false'
  optimize_level:
    description: 'Compiler optimization level: O2 (balanced) or O3 (aggressive)'
    required: false
    default: 'O2'
  clean:
    description: 'Force clean build without ccache acceleration'
    required: false
    default: 'false'
  github_token:
    description: 'GitHub token for API access (SUSFS module download)'
    required: true
    
outputs:
  kernel_version:
    description: 'Built kernel version (e.g., android14-6.1.75)'
    value: ${{ steps.save_metadata.outputs.kernel_version }}
  sukisu_version:
    description: 'SukiSU manager version number'
    value: ${{ steps.save_metadata.outputs.sukisu_version }}
  susfs_version:
    description: 'SUSFS version string'
    value: ${{ steps.save_metadata.outputs.susfs_version }}
  image_sha256:
    description: 'SHA256 hash of kernel Image'
    value: ${{ steps.collect_stats.outputs.image_sha256 }}
  zip_name:
    description: 'Flashable ZIP filename'
    value: ${{ steps.create_zip.outputs.zip_name }}
  zip_sha256:
    description: 'SHA256 hash of flashable ZIP'
    value: ${{ steps.create_zip.outputs.zip_sha256 }}
  zip_size:
    description: 'ZIP file size in bytes'
    value: ${{ steps.create_zip.outputs.zip_size }}
  build_time:
    description: 'Total build time in seconds'
    value: ${{ steps.collect_stats.outputs.build_time }}
  ccache_hit_rate:
    description: 'ccache hit rate percentage'
    value: ${{ steps.ccache_stats.outputs.hit_rate }}
  ccache_direct_rate:
    description: 'ccache direct hit rate percentage'
    value: ${{ steps.ccache_stats.outputs.direct_rate }}
  warnings_count:
    description: 'Number of compiler warnings'
    value: ${{ steps.collect_stats.outputs.warnings_count }}
  errors_count:
    description: 'Number of build errors parsed from log'
    value: ${{ steps.collect_stats.outputs.errors_count }}

runs:
  using: 'composite'
  steps:
    
    - name: Parse op_config_json
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Parse configuration JSON"
        echo '${{ inputs.op_config_json }}' > /tmp/config.json
        jq -r 'to_entries[] | "OP_\(.key | ascii_upcase)=\(.value)"' /tmp/config.json >> "$GITHUB_ENV"
        echo "‚úÖ Parsed configuration:"
        jq '.' /tmp/config.json
        echo "::endgroup::"

    - name: Validate Inputs
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Validate inputs"
        
        # ‚úÖ FIX: Read from environment with default values
        model="${OP_MODEL:-}"
        soc="${OP_SOC:-}"
        branch="${OP_BRANCH:-}"
        manifest="${OP_MANIFEST:-}"
        android_version="${OP_ANDROID_VERSION:-}"
        kernel_version="${OP_KERNEL_VERSION:-}"
        os_version="${OP_OS_VERSION:-}"
        
        # ‚úÖ FIX: Optional boolean fields with defaults
        hmbird="${OP_HMBIRD:-false}"
        susfs="${OP_SUSFS:-true}"
        bbg="${OP_BBG:-false}"
        bbr="${OP_BBR:-true}"
        ttl="${OP_TTL:-true}"
        ip_set="${OP_IP_SET:-true}"
        
        optimize='${{ inputs.optimize_level }}'
        
        errors=()
        
        # Model validation
        if [[ -z "$model" ]]; then
          errors+=("Input 'model' cannot be empty")
        elif [[ ! "$model" =~ ^OP ]]; then
          errors+=("Input 'model' must start with 'OP'. Got: '$model'")
        fi
        
        # SoC validation
        if [[ -z "$soc" ]]; then
          errors+=("Input 'soc' cannot be empty")
        elif [[ ! "$soc" =~ ^[A-Za-z0-9_-]+$ ]]; then
          errors+=("Input 'soc' contains invalid characters. Got: '$soc'")
        fi
        
        # Branch validation
        if [[ -z "$branch" ]]; then
          errors+=("Input 'branch' cannot be empty")
        elif [[ ! "$branch" =~ ^[A-Za-z0-9._/-]+$ ]]; then
          errors+=("Input 'branch' contains invalid characters. Got: '$branch'")
        fi
        
        # Manifest validation
        if [[ -z "$manifest" ]]; then
          errors+=("Input 'manifest' cannot be empty")
        elif [[ "$manifest" == http*://* ]]; then
          if [[ ! "$manifest" =~ ^https:// ]]; then
            errors+=("Manifest URL must be HTTPS. Got: '$manifest'")
          fi
          if [[ ! "$manifest" =~ \.xml($|\?) ]]; then
            errors+=("Manifest URL must point to .xml file. Got: '$manifest'")
          fi
        else
          if [[ ! "$manifest" =~ \.xml$ ]]; then
            errors+=("Manifest filename must end with .xml. Got: '$manifest'")
          fi
        fi
        
        # Android version validation
        if [[ -z "$android_version" ]]; then
          errors+=("Input 'android_version' cannot be empty")
        elif [[ ! "$android_version" =~ ^android[0-9]+$ ]]; then
          errors+=("Input 'android_version' must be 'androidXX'. Got: '$android_version'")
        fi
        
        # Kernel version validation
        if [[ -z "$kernel_version" ]]; then
          errors+=("Input 'kernel_version' cannot be empty")
        elif [[ ! "$kernel_version" =~ ^[0-9]+\.[0-9]+$ ]]; then
          errors+=("Input 'kernel_version' must be 'X.Y' format. Got: '$kernel_version'")
        fi
        
        # ‚úÖ FIX: OS version is now optional (for generic builds)
        if [[ -n "$os_version" ]]; then
          if [[ ! "$os_version" =~ ^OOS ]]; then
            errors+=("Input 'os_version' must start with 'OOS' or be empty. Got: '$os_version'")
          fi
        else
          echo "‚ÑπÔ∏è  os_version not provided - using generic naming"
          os_version="Generic"
        fi
        
        # ‚úÖ FIX: Boolean validations with proper defaults
        for var in hmbird susfs bbg bbr ttl ip_set; do
          val="${!var}"
          if [[ "$val" != "true" && "$val" != "false" ]]; then
            errors+=("Input '$var' must be 'true' or 'false'. Got: '$val'")
          fi
        done
        
        # Optimization level validation
        case "$optimize" in
          O2|O3) ;;
          *) errors+=("optimize_level must be O2 or O3. Got: '$optimize'") ;;
        esac
        
        # Report errors
        if [ ${#errors[@]} -ne 0 ]; then
          echo "::error::Found ${#errors[@]} validation error(s):"
          for error in "${errors[@]}"; do
            echo "  ‚ùå $error"
          done
          exit 1
        fi
        
        # ‚úÖ Export validated values back to environment
        {
          echo "OP_OS_VERSION=$os_version"
          echo "OP_HMBIRD=$hmbird"
          echo "OP_SUSFS=$susfs"
          echo "OP_BBG=$bbg"
          echo "OP_BBR=$bbr"
          echo "OP_TTL=$ttl"
          echo "OP_IP_SET=$ip_set"
        } >> "$GITHUB_ENV"
        
        echo ""
        echo "‚úÖ All inputs validated successfully"
        echo ""
        echo "üìã Configuration Summary:"
        echo "   Model: $model"
        echo "   SoC: $soc"
        echo "   Branch: $branch"
        echo "   Android: $android_version"
        echo "   Kernel: $kernel_version"
        echo "   OS Version: $os_version"
        echo ""
        echo "üîß Feature Flags:"
        echo "   SUSFS: $susfs"
        echo "   HMBIRD: $hmbird"
        echo "   BBG (LSM): $bbg"
        echo "   BBR: $bbr"
        echo "   TTL: $ttl"
        echo "   IP_SET: $ip_set"
        echo "   Optimization: $optimize"
        
        echo "::endgroup::"

    - name: Install Minimal Dependencies
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Install dependencies"
        sudo apt-get -o Acquire::Retries=3 update -qq
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
          git curl ca-certificates build-essential clang lld flex bison \
          libelf-dev libssl-dev libncurses-dev zlib1g-dev liblz4-tool \
          libxml2-utils rsync unzip zip dwarves file python3 ccache jq bc dos2unix
        sudo apt-get clean
        echo "‚úÖ Dependencies installed"
        echo "::endgroup::"
    
    - name: Free Disk Space Early
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Free disk space"
        echo "Before cleanup:"
        df -h /
        
        if command -v docker >/dev/null 2>&1; then
          docker system prune -af 2>/dev/null || true
        fi
        
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost || true
        sudo rm -rf /opt/hostedtoolcache/CodeQL || true
        sudo rm -rf "$AGENT_TOOLSDIRECTORY" || true
        
        echo ""
        echo "After cleanup:"
        df -h /
        echo "::endgroup::"

    - name: Setup Base Environment
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Setup base environment"
        
        # ‚úÖ FIX: Define CONFIG based on OP_MODEL
        CONFIG="${OP_MODEL}"
        echo "CONFIG=$CONFIG" >> "$GITHUB_ENV"
        echo "üìÅ Configuration directory: $CONFIG"
        
        # Setup repo tool
        REPO="/usr/local/bin/repo"
        if [ ! -x "$REPO" ]; then
          echo "Downloading repo tool..."
          curl -s https://storage.googleapis.com/git-repo-downloads/repo -o "$REPO"
          chmod +x "$REPO"
        fi
        echo "REPO=$REPO" >> "$GITHUB_ENV"
        
        echo "‚úÖ Base environment configured"
        echo "::endgroup::"

    - name: Check System Resources
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::System resources"
        echo "üìä Available resources:"
        echo ""
        echo "RAM:"
        free -h
        echo ""
        echo "Disk:"
        df -h / | tail -n1
        echo ""
        echo "CPU:"
        echo "  Cores: $(nproc --all)"
        echo "  Model: $(lscpu | grep 'Model name' | cut -d: -f2 | xargs)"
        echo "::endgroup::"

    - name: Initialize and Sync Kernel Source
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Initialize kernel source"
        echo "Creating folder for configuration: $CONFIG"
        mkdir -p "$CONFIG"
        cd "$CONFIG"
        echo "Initializing and syncing kernel source..."
        
        if [[ "$OP_MANIFEST" == https://* ]]; then
          mkdir -p .repo/manifests
          curl --fail --show-error --location --proto '=https' "$OP_MANIFEST" -o .repo/manifests/temp_manifest.xml
          
          "$REPO" init -u https://github.com/OnePlusOSS/kernel_manifest.git \
            -b "$OP_BRANCH" \
            -m temp_manifest.xml --repo-rev=v2.16 --depth=1 --no-clone-bundle --no-tags
        else
          "$REPO" init -u https://github.com/OnePlusOSS/kernel_manifest.git \
            -b "$OP_BRANCH" \
            -m "$OP_MANIFEST" --repo-rev=v2.16 --depth=1 --no-clone-bundle --no-tags
        fi
        
        "$REPO" --version
        success=false
        for i in 1 2 3; do
          if "$REPO" sync -c --no-clone-bundle --no-tags --optimized-fetch \
             -j"$(nproc --all)" --fail-fast; then
            success=true
            break
          fi
          echo "‚ö†Ô∏è repo sync attempt $i failed; retrying..."
          sleep 30
        done
        $success || { echo "::error::repo sync failed after 3 attempts"; exit 1; }
        echo "‚úÖ Kernel source synced"
        echo "::endgroup::"

    - name: Get Kernel Version Info
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Get kernel version"
        
        CONFIG_DIR="$GITHUB_WORKSPACE/$CONFIG"
        
        # ‚úÖ Create and export ARTIFACTS_DIR globally
        ARTIFACTS_DIR="$CONFIG_DIR/artifacts"
        mkdir -p "$ARTIFACTS_DIR"
        echo "ARTIFACTS_DIR=$ARTIFACTS_DIR" >> "$GITHUB_ENV"
        
        # Verify directory was created successfully
        if [ ! -d "$ARTIFACTS_DIR" ]; then
          echo "::error::Failed to create ARTIFACTS_DIR: $ARTIFACTS_DIR"
          exit 1
        fi
        
        echo "üìÅ Artifacts directory: $ARTIFACTS_DIR"
        
        # Navigate to kernel source
        cd "$CONFIG_DIR/kernel_platform/common"
        
        # Find BRANCH= line in build config files
        CONFIG_FILES=("build.config.common" "build.config.constants")
        BRANCH_LINE=""
        
        for f in "${CONFIG_FILES[@]}"; do
          if [ -f "$f" ]; then
            l=$(grep '^[[:space:]]*BRANCH=' "$f" 2>/dev/null || true)
            if [ -n "$l" ]; then
              BRANCH_LINE="$l"
              echo "Found BRANCH in: $f"
              break
            fi
          fi
        done
        
        # Validate BRANCH was found
        if [ -z "$BRANCH_LINE" ]; then
          echo "::error::No BRANCH= found in config files"
          echo "Searched files:"
          for f in "${CONFIG_FILES[@]}"; do
            if [ -f "$f" ]; then
              echo "  - $f (exists)"
            else
              echo "  - $f (NOT FOUND)"
            fi
          done
          exit 1
        fi
        
        # Extract Android version from BRANCH
        BRANCH_VALUE="${BRANCH_LINE#*=}"
        BRANCH_VALUE="${BRANCH_VALUE//\"/}"  # Remove quotes if present
        ANDROID_VERSION="${BRANCH_VALUE%-*}"
        
        if [ -z "$ANDROID_VERSION" ]; then
          echo "::error::Could not parse android version from BRANCH=$BRANCH_VALUE"
          exit 1
        fi
        
        echo "Detected BRANCH: $BRANCH_VALUE"
        echo "Android version: $ANDROID_VERSION"
        
        # Extract kernel version from Makefile
        if [ ! -f "Makefile" ]; then
          echo "::error::Makefile not found in $(pwd)"
          exit 1
        fi
        
        VERSION=$(grep '^VERSION *=' Makefile | head -n1 | awk '{print $3}')
        PATCHLEVEL=$(grep '^PATCHLEVEL *=' Makefile | head -n1 | awk '{print $3}')
        SUBLEVEL=$(grep '^SUBLEVEL *=' Makefile | head -n1 | awk '{print $3}')
        
        # Validate extracted values
        if [ -z "$VERSION" ] || [ -z "$PATCHLEVEL" ]; then
          echo "::error::Failed to extract kernel version from Makefile"
          echo "VERSION: ${VERSION:-NOT FOUND}"
          echo "PATCHLEVEL: ${PATCHLEVEL:-NOT FOUND}"
          exit 1
        fi
        
        # SUBLEVEL can be empty (defaults to 0)
        SUBLEVEL="${SUBLEVEL:-0}"
        
        FULL_VERSION="$VERSION.$PATCHLEVEL.$SUBLEVEL"
        
        echo "Kernel version components:"
        echo "  VERSION: $VERSION"
        echo "  PATCHLEVEL: $PATCHLEVEL"
        echo "  SUBLEVEL: $SUBLEVEL"
        echo "  FULL_VERSION: $FULL_VERSION"
        
        # Save version info to artifacts
        cd "$ARTIFACTS_DIR"
        echo "$ANDROID_VERSION-$FULL_VERSION" > "${OP_MODEL}_${OP_OS_VERSION}.txt"
        echo "$OP_OS_VERSION" >> "${OP_MODEL}_${OP_OS_VERSION}.txt"
        
        # Export environment variables
        {
          echo "ANDROID_VER=$ANDROID_VERSION"
          echo "KERNEL_VER=$VERSION.$PATCHLEVEL"
          echo "TKERNEL_VER=$FULL_VERSION"
          echo "KERNEL_FULL_VER=$ANDROID_VERSION-$FULL_VERSION"
        } >> "$GITHUB_ENV"
        
        # Export SUSFS branch only if SUSFS is enabled
        if [ "${OP_SUSFS:-false}" = "true" ]; then
          SUSFS_BRANCH="gki-$ANDROID_VERSION-$VERSION.$PATCHLEVEL"
          echo "SUSFS_KERNEL_BRANCH=$SUSFS_BRANCH" >> "$GITHUB_ENV"
          echo "SUSFS branch: $SUSFS_BRANCH"
        fi
        
        echo ""
        echo "‚úÖ Kernel version detection completed"
        echo "   Full version: $ANDROID_VERSION-$FULL_VERSION"
        echo "   Artifacts directory: $ARTIFACTS_DIR"
        
        if [ "${OP_SUSFS:-false}" = "true" ]; then
          echo "   SUSFS branch: gki-$ANDROID_VERSION-$VERSION.$PATCHLEVEL"
        fi
        
        echo "::endgroup::"

    - name: Detect Clang
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Detect Clang"
        KP="$GITHUB_WORKSPACE/$CONFIG/kernel_platform"
        CLANG_FOUND=false
        for base in "$KP/prebuilts" "$KP/prebuilts-master"; do
          [ -d "$base/clang/host/linux-x86" ] || continue
          latest=$(ls -d "$base"/clang/host/linux-x86/clang-r*/ 2>/dev/null | sort -V | tail -n1 || true)
          if [ -n "$latest" ] && [ -x "$latest/bin/clang" ]; then
            CLANG_BIN="$latest/bin"
            CLANG_FOUND=true
            break
          fi
        done
        if ! $CLANG_FOUND && command -v clang >/dev/null 2>&1; then
          CLANG_BIN="$(dirname "$(command -v clang)")"
          CLANG_FOUND=true
          echo "Using system clang."
        fi
        $CLANG_FOUND || { echo "::error::No clang toolchain found"; exit 1; }
        echo "CLANG_BIN_PATH=$CLANG_BIN" >> "$GITHUB_ENV"
        CLANG_VERSION="$("$CLANG_BIN/clang" --version | head -n1)"
        echo "CLANG_VERSION=$CLANG_VERSION" >> "$GITHUB_ENV"
        echo "‚úÖ Detected Clang: $CLANG_VERSION"
        echo "::endgroup::"
   
    - name: Derive Clang Short Version
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Derive Clang fingerprint"
        
        short=""
        
        # ‚úÖ Method 1: Extract from toolchain directory path
        toolchain_dir="$(dirname "${CLANG_BIN_PATH}")"
        if echo "$toolchain_dir" | grep -qE '/clang-r[0-9]+[a-z]?$'; then
          short="$(basename "$toolchain_dir" | sed 's/^clang-//')"
          echo "‚úÖ Extracted from path: $short"
        fi
        
        # ‚úÖ Method 2: Extract from CLANG_BIN_PATH itself
        if [ -z "$short" ] && echo "${CLANG_BIN_PATH}" | grep -qE 'clang-r[0-9]+[a-z]?'; then
          short="$(echo "${CLANG_BIN_PATH}" | grep -oE 'clang-r[0-9]+[a-z]?' | tail -1 | sed 's/^clang-//')"
          echo "‚úÖ Extracted from bin path: $short"
        fi
        
        # ‚úÖ Method 3: Read from build.config.constants
        if [ -z "$short" ]; then
          config_file="$GITHUB_WORKSPACE/$CONFIG/kernel_platform/common/build.config.constants"
          if [ -f "$config_file" ]; then
            short="$(awk -F= '/^CLANG_VERSION=/{gsub(/^[ "]+|[ "]+$/,"",$2); gsub(/^clang-/,"",$2); print $2; exit}' "$config_file")"
            if [ -n "$short" ]; then
              echo "‚úÖ Extracted from build.config.constants: $short"
            fi
          fi
        fi
        
        # ‚úÖ Method 4: Parse from clang --version output
        if [ -z "$short" ]; then
          short="$("${CLANG_BIN_PATH}/clang" --version | sed -n '1s/.*clang-r\([0-9]\+[a-z]\?\).*/\1/p')"
          if [ -n "$short" ]; then
            echo "‚úÖ Extracted from version string: $short"
          fi
        fi
        
        # ‚úÖ Fallback: Use default value
        if [ -z "$short" ]; then
          short="r487747c"
          echo "‚ö†Ô∏è Could not extract version, using default: $short"
        fi
        
        # ‚úÖ Normalize known versions
        case "$short" in
          r510928*) short="r510928" ;;
          r487747*) short="r487747c" ;;
          r475365*) short="r475365" ;;
          r450784*) short="r450784d" ;;
          r445002*) short="r445002" ;;
          r416183*) short="r416183b" ;;
        esac
        
        echo "CLANG_VERSION_SHORT=$short" >> "$GITHUB_ENV"
        
        CLANG_FULL_VERSION="$("${CLANG_BIN_PATH}/clang" --version | head -n1)"
        echo "CLANG_FULL_VERSION=$CLANG_FULL_VERSION" >> "$GITHUB_ENV"
        
        echo "üìå Final Clang fingerprint: $short"
        echo "   Full version: $CLANG_FULL_VERSION"
        echo "::endgroup::"

    - name: Validate Clang Path
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Validate Clang toolchain"
        
        if [ ! -d "${CLANG_BIN_PATH}" ]; then
          echo "::error::Clang binary path does not exist: ${CLANG_BIN_PATH}"
          exit 1
        fi
        
        if [ ! -x "${CLANG_BIN_PATH}/clang" ]; then
          echo "::error::Clang binary not executable: ${CLANG_BIN_PATH}/clang"
          exit 1
        fi
        
        echo "‚úÖ Clang toolchain validated"
        echo "   Path: ${CLANG_BIN_PATH}"
        echo "   Version: ${CLANG_VERSION}"
        echo "   Fingerprint: ${CLANG_VERSION_SHORT}"
        echo "::endgroup::"
       
    - name: Configure ccache
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Configure ccache for maximum performance"
        
        # ‚úÖ FIX: Set directory and max size
        export CCACHE_DIR="$HOME/.ccache"
        export CCACHE_MAXSIZE="2G"
        
        mkdir -p "$CCACHE_DIR"
        
        # ‚úÖ FIX: Persist max size to config file
        ccache -M "$CCACHE_MAXSIZE"
        
        # ‚úÖ FIX: Optimal configuration for kernel builds
        ccache -o compression=true
        ccache -o compression_level=3
        ccache -o max_files=0
        ccache -o direct_mode=true
        ccache -o hash_dir=false
        ccache -o file_clone=true || true
        ccache -o inode_cache=true || true
        ccache -o umask=002
        
        # ‚úÖ FIX: Sloppiness for faster compilation
        ccache -o sloppiness=file_macro,time_macros,include_file_mtime,include_file_ctime,pch_defines,system_headers,locale
        
        # ‚úÖ FIX: Readonly direct mode (if supported)
        if ccache --help 2>&1 | grep -q 'readonly_direct'; then
          ccache -o readonly_direct=true
          echo "‚úÖ readonly_direct enabled"
        fi
        
        # ‚úÖ FIX: Depend mode (if supported)
        if ccache --help 2>&1 | grep -q 'depend_mode'; then
          ccache -o depend_mode=true
          echo "‚úÖ depend_mode enabled"
        fi
        
        # Export environment variables
        {
          echo "CCACHE_DIR=$CCACHE_DIR"
          echo "CCACHE_MAXSIZE=$CCACHE_MAXSIZE"
          echo "CCACHE_COMPILERCHECK=content"
          echo "CCACHE_BASEDIR=${GITHUB_WORKSPACE}"
          echo "CCACHE_NOHASHDIR=true"
          echo "CCACHE_IGNOREOPTIONS=--sysroot*"
        } >> "$GITHUB_ENV"
        
        echo ""
        echo "‚úÖ ccache configured successfully"
        echo "   Directory: $CCACHE_DIR"
        echo "   Max size: 2G (persisted)"
        echo "   Compression: zstd level 3"
        echo "   Direct mode: enabled"
        echo "   Readonly direct: $(ccache --help 2>&1 | grep -q 'readonly_direct' && echo 'enabled' || echo 'not supported')"
        
        # Show pre-build stats
        if [ -d "$CCACHE_DIR" ] && find "$CCACHE_DIR" -type f -print -quit 2>/dev/null | grep -q .; then
          echo ""
          echo "üìä Pre-build cache statistics:"
          ccache -s | head -n 20
        else
          echo ""
          echo "‚ÑπÔ∏è  No existing cache - cold build"
        fi
        
        echo "::endgroup::"

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-suki-v4-${{ env.OP_MODEL }}-${{ env.ANDROID_VER }}-${{ env.KERNEL_FULL_VER }}-${{ env.CLANG_VERSION_SHORT }}
        restore-keys: |
          ccache-suki-v4-${{ env.OP_MODEL }}-${{ env.ANDROID_VER }}-${{ env.KERNEL_FULL_VER }}-
          ccache-suki-v4-${{ env.OP_MODEL }}-${{ env.ANDROID_VER }}-
          ccache-suki-v4-${{ env.OP_MODEL }}-

    - name: Verify ccache
      if: ${{ inputs.clean != 'true' }}
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Verify ccache"
        
        if [ -d "$CCACHE_DIR" ] && find "$CCACHE_DIR" -type f -print -quit 2>/dev/null | grep -q .; then
          echo "‚úÖ Cache restored successfully"
          echo ""
          ccache -s | head -n 20
          echo ""
          echo "Cache size: $(du -sh "$CCACHE_DIR" 2>/dev/null | cut -f1)"
        else
          echo "‚ÑπÔ∏è No cache restored - cold build"
          echo "Cache will be populated for future builds"
        fi
        
        echo "::endgroup::"

    - name: Clone AnyKernel3
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Clone AnyKernel3"
        ANYKERNEL_BRANCH="gki-2.0"
        echo "Cloning AnyKernel3 (branch: $ANYKERNEL_BRANCH)..."
        git clone --depth=1 https://github.com/Bouteillepleine/AnyKernel3.git -b "$ANYKERNEL_BRANCH" &
        git clone --depth=1 https://github.com/Bouteillepleine/kernel_patches.git &
        wait
        echo "‚úÖ AnyKernel3 cloned"
        echo "::endgroup::"

    - name: Clean Up ABI Protected Exports
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        rm -f common/android/abi_gki_protected_exports_* || true
        rm -f msm-kernel/android/abi_gki_protected_exports_* || true
        df -h

    - name: Add BBG (LSM)
      if: ${{ inputs.lsm == 'true' }}
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Add BBG LSM"
        cd "$CONFIG/kernel_platform"
        echo "Adding BBG..."
        if ! wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash; then
          echo "::warning::BBG setup script failed, continuing anyway"
        fi
        echo "CONFIG_BBG=y" >> common/arch/arm64/configs/gki_defconfig
        sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' common/security/Kconfig
        echo "‚úÖ BBG LSM added"
        echo "::endgroup::"

    - name: Add SukiSU Ultra
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Add SukiSU Ultra"
        cd "$CONFIG/kernel_platform"
    
        META="${{ inputs.ksu_meta }}"
        if [[ "$(grep -o '/' <<< "$META" | wc -l)" -lt 2 ]]; then
          echo "::error::Invalid 'ksu_meta' format. Expected: branch/custom_tag/commit_hash"
          echo "Example: susfs-main/Ultra/abc12345"
          exit 1
        fi
    
        IFS='/' read -r BRANCH_NAME CUSTOM_TAG MANUAL_HASH <<< "$META"
    
        echo "Branch: $BRANCH_NAME"
        echo "Custom Tag: ${CUSTOM_TAG:-Not set}"
        echo "Manual Commit: ${MANUAL_HASH:-Not set}"
    
        echo "Downloading KernelSU setup script..."
        if ! curl -LSs --retry 3 --retry-delay 2 --connect-timeout 30 \
             "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s "$BRANCH_NAME"; then
          echo "::error::KernelSU setup script failed"
          exit 1
        fi
    
        if [ ! -d "./KernelSU" ]; then
          echo "::error::KernelSU directory was not created after setup"
          ls -la
          exit 1
        fi
    
        cd ./KernelSU
    
        if [[ -n "$MANUAL_HASH" ]]; then
          echo "Checking out specified commit: $MANUAL_HASH"
          if ! git fetch origin "$BRANCH_NAME" --depth=50; then
            echo "::error::Failed to fetch branch '$BRANCH_NAME'"
            exit 1
          fi
          if ! git checkout "$MANUAL_HASH"; then
            echo "::error::Failed to checkout commit '$MANUAL_HASH'"
            exit 1
          fi
          SHORT_HASH="${MANUAL_HASH:0:8}"
        fi
    
        echo "::group::Fix sulog.c missing linux/version.h"
        SULOG_PATH="./kernel/sulog.c"
        
        if [ -f "$SULOG_PATH" ]; then
          if ! grep -q '#include <linux/version.h>' "$SULOG_PATH"; then
            echo "Patching sulog.c to include linux/version.h..."
            sed -i '0,/^#include/s|^\(#include.*\)$|\1\n#include <linux/version.h>|' "$SULOG_PATH"
            
            if grep -q '#include <linux/version.h>' "$SULOG_PATH"; then
              echo "‚úÖ Successfully added linux/version.h to sulog.c"
            else
              echo "::error::Failed to add linux/version.h to sulog.c"
              exit 1
            fi
          else
            echo "‚úÖ linux/version.h already included in sulog.c"
          fi
        else
          echo "‚ö†Ô∏è Warning: sulog.c not found at $SULOG_PATH"
        fi
        echo "::endgroup::"
    
        echo "Determining KSU API version..."
        KSU_API_VERSION=$(curl -fsSL --retry 3 --connect-timeout 30 \
          "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/$BRANCH_NAME/kernel/Makefile" 2>/dev/null | \
          grep -m1 "KSU_VERSION_API :=" | awk -F'= ' '{print $2}' | tr -d '[:space:]' || true)
        
        if [[ -z "$KSU_API_VERSION" ]] && [ -f "kernel/Makefile" ]; then
          KSU_API_VERSION=$(grep -m1 "KSU_VERSION_API :=" kernel/Makefile | awk -F'= ' '{print $2}' | tr -d '[:space:]' || true)
        fi
        
        if [[ -z "$KSU_API_VERSION" || "$(printf '%s\n' "$KSU_API_VERSION" "3.1.7" | sort -V | head -n1)" != "3.1.7" ]]; then
          echo "Warning: Invalid or missing API version. Using default: 3.1.7"
          KSU_API_VERSION="3.1.7"
        fi
    
        echo "KSU API Version: $KSU_API_VERSION"
        echo "KSU_API_VERSION=$KSU_API_VERSION" >> "$GITHUB_ENV"
    
        GIT_HASH=$(git rev-parse --short HEAD)
        echo "GIT_HASH=$GIT_HASH"
    
        if [[ -n "$MANUAL_HASH" ]]; then
          USE_HASH="$SHORT_HASH"
        else
          USE_HASH="$GIT_HASH"
        fi
        
        if [[ -z "$CUSTOM_TAG" ]]; then
          VERSION_FULL="v$KSU_API_VERSION-$USE_HASH@$BRANCH_NAME"
        else
          VERSION_FULL="v$KSU_API_VERSION-$CUSTOM_TAG@$BRANCH_NAME[$USE_HASH]"
        fi
    
        echo "Injecting version info into kernel/Makefile..."
        sed -i '/define get_ksu_version_full/,/endef/d' kernel/Makefile
        sed -i '/KSU_VERSION_API :=/d' kernel/Makefile
        sed -i '/KSU_VERSION_FULL :=/d' kernel/Makefile
    
        VERSION_DEFINITIONS=$(cat <<EOF
          define get_ksu_version_full
          $VERSION_FULL
          endef

          KSU_VERSION_API := $KSU_API_VERSION
          KSU_VERSION_FULL := $VERSION_FULL
        EOF
        )
    
        awk -v def="$VERSION_DEFINITIONS" '
          /REPO_OWNER :=/ {print; print def; inserted=1; next}
          1
          END {if (!inserted) print def}
        ' kernel/Makefile > kernel/Makefile.tmp && mv kernel/Makefile.tmp kernel/Makefile
    
        KSU_VERSION=$(expr $(git rev-list --count main 2>/dev/null || echo 13000) + 37185)
        echo "SUKISUVER=$KSU_VERSION" >> "$GITHUB_ENV"
    
        echo "::group::Makefile Version Preview"
        echo "Full Version: $VERSION_FULL"
        echo "Manager Version: $KSU_VERSION"
        grep -A10 "REPO_OWNER" kernel/Makefile || true
        grep "KSU_VERSION_FULL" kernel/Makefile || true
        echo "::endgroup::"
    
        echo "‚úÖ SukiSU Ultra successfully added"
        echo "   Version: $VERSION_FULL"
        echo "   Manager: v$KSU_VERSION"
        echo "::endgroup::"

    - name: Apply SUSFS Patches
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Apply SUSFS patches"
        cd "$GITHUB_WORKSPACE"
        
        SUSFS_BRANCH="${SUSFS_KERNEL_BRANCH}"
        echo "Cloning SUSFS repository (branch: $SUSFS_BRANCH)..."
        if ! git clone https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH" --depth=1 2>&1 | tee /tmp/susfs_clone.log; then
          echo "::error::Failed to clone SUSFS repository"
          cat /tmp/susfs_clone.log
          exit 1
        fi
        
        echo "Cloning SukiSU patch repository..."
        if ! git clone https://github.com/ShirkNeko/SukiSU_patch.git --depth=1 2>&1 | tee /tmp/patch_clone.log; then
          echo "::error::Failed to clone SukiSU_patch repository"
          cat /tmp/patch_clone.log
          exit 1
        fi
        
        cd "$CONFIG/kernel_platform"
        
        echo "Copying SUSFS files..."
        SUSFS_PATCH="50_add_susfs_in_gki-${{ env.ANDROID_VER }}-${{ env.KERNEL_VER }}.patch"
        
        if [ ! -f "$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/$SUSFS_PATCH" ]; then
          echo "::error::SUSFS patch not found: $SUSFS_PATCH"
          echo "Available patches:"
          ls -la "$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/" || true
          exit 1
        fi
        
        cp "$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/$SUSFS_PATCH" ./common/
        cp -r "$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/fs/"* ./common/fs/
        cp -r "$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/include/linux/"* ./common/include/linux/
        
        if [ "${{ inputs.enable_zram }}" = "true" ]; then
          echo "Copying ZRAM source files..."
          if [ -d "$GITHUB_WORKSPACE/SukiSU_patch/other/zram/lz4k" ]; then
            cp -r "$GITHUB_WORKSPACE/SukiSU_patch/other/zram/lz4k/include/linux/"* ./common/include/linux/
            cp -r "$GITHUB_WORKSPACE/SukiSU_patch/other/zram/lz4k/lib/"* ./common/lib/
            cp -r "$GITHUB_WORKSPACE/SukiSU_patch/other/zram/lz4k/crypto/"* ./common/crypto/
            cp -r "$GITHUB_WORKSPACE/SukiSU_patch/other/zram/lz4k_oplus" ./common/lib/
            echo "‚úÖ ZRAM modules included"
          else
            echo "‚ö†Ô∏è ZRAM modules directory not found"
          fi
        fi
        
        cd ./common
        
        if [ -f "./include/linux/susfs.h" ]; then
          SUSFS_VERSION=$(grep '#define SUSFS_VERSION' ./include/linux/susfs.h | awk -F'"' '{print $2}')
          echo "SUSFS_VERSION=$SUSFS_VERSION" >> $GITHUB_ENV
          echo "SUSVER=$SUSFS_VERSION" >> $GITHUB_ENV
          echo "Detected SUSFS version: $SUSFS_VERSION"
        fi
        
        GKI_V="${{ env.ANDROID_VER }}-${{ env.KERNEL_VER }}"
        SUBLEVEL=$(grep '^SUBLEVEL *=' Makefile | head -n1 | cut -d= -f2 | tr -d ' ')
        
        if [ "$GKI_V" = "android13-5.15" ] && [ "$SUBLEVEL" -lt 123 ]; then
          echo "Fixing legacy 5.15 issues (SUBLEVEL=$SUBLEVEL)..."
          if curl -Lo fix_5.15.legacy.patch --retry 5 --retry-delay 2 --retry-connrefused \
            "https://raw.githubusercontent.com/Numbersf/Action-Build/SukiSU-Ultra/patches/fix_5.15.legacy"; then
            if patch -p1 < fix_5.15.legacy.patch; then
              echo "‚úÖ Legacy 5.15 patch applied"
            else
              echo "::warning::Legacy 5.15 patch applied with warnings"
            fi
          else
            echo "::warning::Failed to download 5.15 legacy patch"
          fi
        fi
        
        KERNEL_VERSION="${{ env.KERNEL_VER }}"
        TKERNEL_VERSION="${{ env.TKERNEL_VER }}"
        TRUSTY_EXISTS="false"
        
        if [[ "$KERNEL_VERSION" == "6.6" ]] || [[ "$KERNEL_VERSION" == "6.12" ]]; then
          if [ -f "$GITHUB_WORKSPACE/$CONFIG/.repo/manifests_fallback/$OP_MANIFEST" ]; then
            if grep -q 'common-modules/trusty' "$GITHUB_WORKSPACE/$CONFIG/.repo/manifests_fallback/$OP_MANIFEST" 2>/dev/null; then
              TRUSTY_EXISTS="true"
            fi
          fi
          
          if [[ "$KERNEL_VERSION" == "6.12" ]]; then
            if [[ "$TRUSTY_EXISTS" == "false" && "$(printf '%s\n' "$TKERNEL_VERSION" "6.12.0" | sort -V | head -n1)" = "$TKERNEL_VERSION" ]]; then
              echo "Fixing SUSFS for 6.12 without Trusty OS..."
              sed -i 's/-32,12 +32,38/-32,11 +32,37/g' "$SUSFS_PATCH"
              sed -i '/#include <trace\/hooks\/fs.h>/d' "$SUSFS_PATCH"
            fi
          elif [[ "$KERNEL_VERSION" == "6.6" ]]; then
            if [[ "$TRUSTY_EXISTS" == "false" && "$(printf '%s\n' "$TKERNEL_VERSION" "6.6.30" | sort -V | head -n1)" = "$TKERNEL_VERSION" ]]; then
              echo "Fixing SUSFS for 6.6 without Trusty OS..."
              sed -i 's/-32,12 +32,38/-32,11 +32,37/g' "$SUSFS_PATCH"
              sed -i '/#include <trace\/hooks\/fs.h>/d' "$SUSFS_PATCH"
            fi
          fi
        fi
        
        fake_patched=0
        
        if [ "$GKI_V" = "android16-6.12" ]; then
          if ! grep -qxF $'\tunsigned int nr_subpages = __PAGE_SIZE / PAGE_SIZE;' ./fs/proc/task_mmu.c; then
            echo "Applying fake patch for android16-6.12"
            sed -i -e '/int ret = 0, copied = 0;/a \\tunsigned int nr_subpages \= __PAGE_SIZE \/ PAGE_SIZE;' \
                   -e '/int ret = 0, copied = 0;/a \\tpagemap_entry_t \*res = NULL;' ./fs/proc/task_mmu.c
            fake_patched=1
          fi
        fi
        
        if [ "$GKI_V" = "android15-6.6" ]; then
          if ! grep -qxF $'\tunsigned int nr_subpages = __PAGE_SIZE / PAGE_SIZE;' ./fs/proc/task_mmu.c; then
            echo "Applying fake patch for android15-6.6"
            sed -i -e '/int ret = 0, copied = 0;/a \\tunsigned int nr_subpages \= __PAGE_SIZE \/ PAGE_SIZE;' \
                   -e '/int ret = 0, copied = 0;/a \\tpagemap_entry_t \*res = NULL;' ./fs/proc/task_mmu.c
            fake_patched=1
          fi
        fi
        
        if [ "$GKI_V" = "android12-5.10" ] || [ "$GKI_V" = "android13-5.15" ]; then
          if ! grep -qxF $'\tif (!vma_pages(vma))' ./fs/proc/task_mmu.c; then
            echo "Fake patch needed for $GKI_V"
            fake_patched=1
          fi
        fi
        
        echo "Applying SUSFS patch: $SUSFS_PATCH"
        if patch -p1 < "$SUSFS_PATCH"; then
          echo "‚úÖ SUSFS patch applied successfully"
        else
          echo "::warning::SUSFS patch applied with warnings"
        fi
        
        if [ "$fake_patched" = 1 ]; then
          echo "Reverting fake patches..."
          
          if [ "$GKI_V" = "android16-6.12" ]; then
            if grep -qxF $'\tunsigned int nr_subpages = __PAGE_SIZE / PAGE_SIZE;' ./fs/proc/task_mmu.c; then
              echo "Reverting fake patch for android16-6.12"
              sed -i -e '/unsigned int nr_subpages \= __PAGE_SIZE \/ PAGE_SIZE;/d' \
                     -e '/pagemap_entry_t \*res = NULL;/d' ./fs/proc/task_mmu.c
            fi
          fi
          
          if [ "$GKI_V" = "android15-6.6" ]; then
            if grep -qxF $'\tunsigned int nr_subpages = __PAGE_SIZE / PAGE_SIZE;' ./fs/proc/task_mmu.c; then
              sed -i -e '/unsigned int nr_subpages \= __PAGE_SIZE \/ PAGE_SIZE;/d' \
                     -e '/pagemap_entry_t \*res = NULL;/d' ./fs/proc/task_mmu.c
            fi
          fi
          if [ "$GKI_V" = "android12-5.10" ] || [ "$GKI_V" = "android13-5.15" ]; then
            if grep -qxF $'\t\tgoto show_pad;' ./fs/proc/task_mmu.c; then
              sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
            fi
          fi
        fi
        
        echo "‚úÖ SUSFS patches applied: ${SUSFS_VERSION:-unknown}"
        echo "::endgroup::"

    - name: Apply Hide Stuff Patches
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Apply hide stuff patches"
        COMMON_DIR="$GITHUB_WORKSPACE/$CONFIG/kernel_platform/common"
        PATCH_DIR="$GITHUB_WORKSPACE/SukiSU_patch"
        
        cd "$COMMON_DIR"
        
        if [ ! -f "$PATCH_DIR/69_hide_stuff.patch" ]; then
          echo "::error::Hide stuff patch not found at: $PATCH_DIR/69_hide_stuff.patch"
          exit 1
        fi
        
        cp "$PATCH_DIR/69_hide_stuff.patch" ./
        echo "Applying hide stuff patch..."
        if patch -p1 -F 3 < 69_hide_stuff.patch; then
          echo "‚úÖ Hide stuff patch applied successfully"
        else
          echo "::warning::Hide stuff patch applied with warnings"
        fi
        
        echo "‚úÖ Hide stuff patches applied"
        echo "::endgroup::"

    - name: Patch KernelSU sulog time64_to_tm clash
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Patch KernelSU sulog compatibility"
        KSP="$GITHUB_WORKSPACE/$CONFIG/kernel_platform/common"
        f="$KSP/drivers/kernelsu/sulog.c"
        
        if [ -f "$f" ] && grep -q 'static inline void time64_to_tm' "$f"; then
          echo "Found time64_to_tm conflict in sulog.c, applying patch..."
          sed -i 's/static inline void time64_to_tm/static inline void ksu_time64_to_tm/' "$f"
          sed -i 's/time64_to_tm(/ksu_time64_to_tm(/g' "$f"
          echo "‚úÖ Patched sulog.c to avoid time64_to_tm conflict"
          echo "   Renamed: time64_to_tm ‚Üí ksu_time64_to_tm"
        else
          echo "‚ÑπÔ∏è No local time64_to_tm helper found in $f; nothing to patch"
        fi
        echo "::endgroup::"

    - name: Apply Other Patches
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Apply other patches"
        cd "$CONFIG/kernel_platform/common"
        
        KERNEL_VERSION="${{ env.KERNEL_VER }}"
        MIN_VERSION="5.16"
        
        echo "Applying optimized memory operations patch..."
        patch -p1 --forward "../../../kernel_patches/common/optimized_mem_operations.patch" || true
        
        echo "Applying file struct alignment patch..."
        patch -p1 --forward "../../../kernel_patches/common/file_struct_8bytes_align.patch" || true
        
        echo "Applying cache pressure reduction patch..."
        patch -p1 --forward "../../../kernel_patches/common/reduce_cache_pressure.patch" || true
        
        echo "Applying clear page alignment patch..."
        if [ "$(printf '%s\n' "$KERNEL_VERSION" "$MIN_VERSION" | sort -V | head -n1)" = "$KERNEL_VERSION" ]; then
          patch -p1 --forward "../../../kernel_patches/common/clear_page_16bytes_align.patch" || true
        else
          cat "../../../kernel_patches/common/clear_page_16bytes_align.patch" | \
            sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' | \
            patch -p1 -F3 --forward || true
        fi
        
        echo "‚úÖ Other patches applied"
        echo "::endgroup::"

    - name: Apply ZRAM Patches
      if: ${{ inputs.enable_zram == 'true' }}
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Apply ZRAM patches"
        cd "$GITHUB_WORKSPACE/$CONFIG/kernel_platform/common"
        
        KERNEL_VER="${{ env.KERNEL_VER }}"
        PATCH_DIR="$GITHUB_WORKSPACE/SukiSU_patch/other/zram/zram_patch/$KERNEL_VER"
        
        if [ ! -d "$PATCH_DIR" ]; then
          echo "::warning::ZRAM patches not found for kernel $KERNEL_VER"
          echo "::endgroup::"
          exit 0
        fi
        
        if [ -f "$PATCH_DIR/lz4kd.patch" ]; then
          cp "$PATCH_DIR/lz4kd.patch" ./
          echo "Applying lz4kd patch..."
          if patch -p1 -F 3 < lz4kd.patch; then
            echo "‚úÖ lz4kd patch applied"
          else
            echo "::warning::lz4kd patch applied with warnings"
          fi
        fi
        
        if [ -f "$PATCH_DIR/lz4k_oplus.patch" ]; then
          cp "$PATCH_DIR/lz4k_oplus.patch" ./
          echo "Applying lz4k_oplus patch..."
          if patch -p1 -F 3 < lz4k_oplus.patch; then
            echo "‚úÖ lz4k_oplus patch applied"
          else
            echo "::warning::lz4k_oplus patch applied with warnings"
          fi
        fi
        
        echo "‚úÖ ZRAM patches applied"
        echo "::endgroup::"

    - name: Apply HMBIRD Patch (6.6)
      if: ${{ inputs.sched == 'true' && env.KERNEL_VER == '6.6' }}
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Apply HMBIRD patch"
        cd "$CONFIG/kernel_platform/common"
        
        echo "Downloading HMBIRD patch..."
        if ! curl -fsSL --retry 3 --retry-delay 2 \
          -o hmbird_patch.patch \
          "https://raw.githubusercontent.com/Numbersf/Action-Build/SukiSU-Ultra/patches/hmbird_patch.patch"; then
          echo "::error::Failed to download HMBIRD patch"
          exit 1
        fi
        
        echo "Adding hmbird_patch.o to drivers/Makefile..."
        if ! grep -q 'hmbird_patch.o' drivers/Makefile; then
          echo 'obj-y += hmbird_patch.o' >> drivers/Makefile
          echo "‚úÖ Added hmbird_patch.o to Makefile"
        else
          echo "‚ÑπÔ∏è hmbird_patch.o already in Makefile"
        fi
        
        echo "Applying HMBIRD patch..."
        if patch -p1 -F 3 < hmbird_patch.patch; then
          echo "‚úÖ HMBIRD patch applied successfully"
        else
          echo "::warning::HMBIRD patch applied with warnings (continuing)"
        fi
        
        echo "::endgroup::"

    - name: Add sched_ext (6.6)
      if: ${{ inputs.sched == 'true' && env.KERNEL_VER == '6.6' }}
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Add sched_ext"
        cd "$CONFIG/kernel_platform"
        
        echo "Cloning sched_ext repository..."
        if ! git clone https://github.com/HanKuCha/sched_ext.git --depth=1; then
          echo "::error::Failed to clone sched_ext repository"
          exit 1
        fi
        
        echo "Copying sched_ext files to kernel..."
        if [ -d "sched_ext" ]; then
          cp -r sched_ext/* ./common/kernel/sched/ || {
            echo "::error::Failed to copy sched_ext files"
            exit 1
          }
          
          echo "Cleaning up sched_ext repository..."
          rm -rf sched_ext/.git sched_ext
          
          echo "‚úÖ sched_ext added successfully"
        else
          echo "::error::sched_ext directory not found after clone"
          exit 1
        fi
        
        echo "::endgroup::"      
   
    - name: Configure Kernel
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Configure kernel"
        cd "$CONFIG/kernel_platform"
        CONFIG_FILE=./common/arch/arm64/configs/gki_defconfig
        
        echo "Adding SukiSU Ultra configuration..."
        cat >> "$CONFIG_FILE" << 'EOF'
        CONFIG_KSU=y
        CONFIG_KPM=y
        CONFIG_KSU_SUSFS=y
        CONFIG_KSU_SUSFS_SUS_PATH=y
        CONFIG_KSU_SUSFS_SUS_MAP=y
        CONFIG_KSU_SUSFS_SUS_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_KSTAT=y
        CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n
        CONFIG_KSU_SUSFS_TRY_UMOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SPOOF_UNAME=y
        CONFIG_KSU_SUSFS_ENABLE_LOG=y
        CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
        CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
        CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
        CONFIG_TMPFS_XATTR=y
        CONFIG_TMPFS_POSIX_ACL=y
        EOF
        
        echo "Adding BBR and Network Optimizations..."
        cat >> "$CONFIG_FILE" <<'EOF'
        
        # Network Scheduling
        CONFIG_NET_SCHED=y
        CONFIG_NET_SCH_INGRESS=y
        CONFIG_NET_FLOW_LIMIT=y
        
        # TCP Congestion Control - BBR
        CONFIG_TCP_CONG_ADVANCED=y
        CONFIG_TCP_CONG_BBR=y
        CONFIG_TCP_CONG_CUBIC=y
        CONFIG_DEFAULT_BBR=y
        CONFIG_DEFAULT_TCP_CONG="bbr"        
        
        # Queue Disciplines
        CONFIG_NET_SCH_FQ=y
        CONFIG_NET_SCH_FQ_CODEL=y
        
        # TCP FastOpen
        CONFIG_TCP_FASTOPEN=y
        CONFIG_TCP_FASTOPEN_DEFAULT=3
        
        # ECN Support
        CONFIG_IP_ECN=y
        CONFIG_TCP_ECN=y
        CONFIG_IPV6_ECN=y
        CONFIG_IP_NF_TARGET_ECN=y
        
        # TCP Optimizations
        CONFIG_TCP_RACK=y
        CONFIG_TCP_TLP=y
        CONFIG_TCP_WINDOW_SCALING=y
        CONFIG_TCP_TIMESTAMPS=y
        CONFIG_TCP_SACK=y
        CONFIG_TCP_FACK=y
        
        # Network Performance
        CONFIG_RPS=y
        CONFIG_RFS_ACCEL=y
        CONFIG_XPS=y
        CONFIG_GRO_CELLS=y
        CONFIG_XFRM_OFFLOAD=y
        EOF
        
        echo "Adding TTL Target Support..."
        cat >> "$CONFIG_FILE" <<'EOF'
        
        # Core Netfilter
        CONFIG_NETFILTER=y
        CONFIG_NETFILTER_ADVANCED=y
        CONFIG_NF_CONNTRACK=y
        CONFIG_NF_CONNTRACK_EVENTS=y
        
        # nftables
        CONFIG_NF_TABLES=y
        CONFIG_NF_TABLES_INET=y
        CONFIG_NF_TABLES_IPV4=y
        CONFIG_NF_TABLES_IPV6=y
        CONFIG_NF_TABLES_ARP=y
        CONFIG_NFT_COMPAT=y
        CONFIG_NFT_COUNTER=y
        CONFIG_NFT_CT=y
        CONFIG_NFT_LOG=y
        CONFIG_NFT_REJECT=y
        CONFIG_NFT_REJECT_INET=y
        CONFIG_NFT_MASQ=y
        CONFIG_NFT_NAT=y
        
        # iptables
        CONFIG_NETFILTER_XTABLES=y
        CONFIG_NETFILTER_XT_TARGET_TCPMSS=y
        CONFIG_NETFILTER_XT_MATCH_TTL=y
        CONFIG_NETFILTER_XT_TARGET_HL=y
        CONFIG_NETFILTER_XT_MATCH_HL=y
        
        # TTL/HL Manipulation
        CONFIG_IP_NF_TARGET_TTL=y
        CONFIG_IP6_NF_TARGET_HL=y
        CONFIG_IP6_NF_MATCH_HL=y
        
        # IPv4 Netfilter
        CONFIG_IP_NF_IPTABLES=y
        CONFIG_IP_NF_FILTER=y
        CONFIG_IP_NF_TARGET_REJECT=y
        CONFIG_IP_NF_NAT=y
        CONFIG_IP_NF_TARGET_MASQUERADE=y
        CONFIG_IP_NF_MANGLE=y
        
        # IPv6 Netfilter
        CONFIG_IP6_NF_IPTABLES=y
        CONFIG_IP6_NF_FILTER=y
        CONFIG_IP6_NF_TARGET_REJECT=y
        CONFIG_IP6_NF_MANGLE=y
        CONFIG_IP6_NF_NAT=y
        CONFIG_IP6_NF_TARGET_MASQUERADE=y
        
        # Advanced Routing
        CONFIG_IP_ADVANCED_ROUTER=y
        CONFIG_IP_MULTIPLE_TABLES=y
        CONFIG_IP_ROUTE_MULTIPATH=y
        EOF
        
        echo "Adding IP SET Support..."
        cat >> "$CONFIG_FILE" <<'EOF'
        
        # IP Set Framework
        CONFIG_IP_SET=y
        CONFIG_IP_SET_MAX=65534
        
        # Bitmap Types
        CONFIG_IP_SET_BITMAP_IP=y
        CONFIG_IP_SET_BITMAP_IPMAC=y
        CONFIG_IP_SET_BITMAP_PORT=y
        
        # Hash Types
        CONFIG_IP_SET_HASH_IP=y
        CONFIG_IP_SET_HASH_IPMARK=y
        CONFIG_IP_SET_HASH_IPPORT=y
        CONFIG_IP_SET_HASH_IPPORTIP=y
        CONFIG_IP_SET_HASH_IPPORTNET=y
        CONFIG_IP_SET_HASH_IPMAC=y
        CONFIG_IP_SET_HASH_MAC=y
        CONFIG_IP_SET_HASH_NETPORTNET=y
        CONFIG_IP_SET_HASH_NET=y
        CONFIG_IP_SET_HASH_NETNET=y
        CONFIG_IP_SET_HASH_NETPORT=y
        CONFIG_IP_SET_HASH_NETIFACE=y
        
        # List Type
        CONFIG_IP_SET_LIST_SET=y
        
        # Netfilter integration
        CONFIG_NETFILTER_XT_SET=y
        CONFIG_NFT_SET_HASH=y
        CONFIG_NFT_SET_BITMAP=y
        CONFIG_NFT_SET_RBTREE=y
        EOF
        
        echo "Adding Build Optimizations..."
        cat >> "$CONFIG_FILE" <<'EOF'
        
        # Link Time Optimization
        CONFIG_LTO_CLANG=y
        CONFIG_LTO_CLANG_THIN=y
        # CONFIG_LTO_CLANG_FULL is not set
        
        # Compiler Optimizations
        CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
        # CONFIG_CC_OPTIMIZE_FOR_SIZE is not set
        # CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3 is not set
        CONFIG_OPTIMIZE_INLINING=y
        
        # Linker Optimizations
        CONFIG_LD_DEAD_CODE_DATA_ELIMINATION=y
        
        # Power Efficiency
        CONFIG_WQ_POWER_EFFICIENT_DEFAULT=y
        EOF
        
        echo "Disabling Debug Options..."
        cat >> "$CONFIG_FILE" <<'EOF'
        
        # Disable Kernel Debugging
        CONFIG_DEBUG_KERNEL=n
        CONFIG_DEBUG_INFO=n
        CONFIG_DEBUG_INFO_DWARF4=n
        
        # Disable Lock Debugging
        CONFIG_LOCK_DEBUGGING=n
        CONFIG_DEBUG_MUTEXES=n
        CONFIG_DEBUG_SPINLOCK=n
        CONFIG_DEBUG_ATOMIC_SLEEP=n
        CONFIG_GDB_SCRIPTS=n
        EOF
        
        # Add ZRAM configs if enabled
        if [ "${{ inputs.enable_zram }}" = "true" ]; then
          echo "Adding ZRAM configuration..."
          cat >> "$CONFIG_FILE" << 'EOF'
        
        # ZRAM Advanced Compressors
        CONFIG_CRYPTO_LZ4HC=y
        CONFIG_CRYPTO_LZ4K=y
        CONFIG_CRYPTO_LZ4KD=y
        CONFIG_CRYPTO_842=y
        CONFIG_CRYPTO_LZ4K_OPLUS=y
        CONFIG_ZRAM_WRITEBACK=y
        EOF
        fi
        
        # Add LSM if enabled
        ENABLE_LSM="${{ inputs.lsm }}"
        if [ "$ENABLE_LSM" = "true" ]; then
          echo "Adding LSM (BBG) configuration..."
          echo "CONFIG_BBG=y" >> "$CONFIG_FILE"
        fi
        
        # Add sched_ext if enabled and kernel is 6.6
        if [ "${{ env.KERNEL_VER }}" = "6.6" ] && [ "${{ inputs.sched }}" = "true" ]; then
          echo "Adding sched_ext configuration..."
          echo "CONFIG_SCHED_CLASS_EXT=y" >> "$CONFIG_FILE"
        fi
        
        # Disable defconfig check
        sed -i 's/check_defconfig//' ./common/build.config.gki

        echo "Generating initial .config..."
        cd ./common
        OUT=out
        mkdir -p "$OUT"
        
        make O="$OUT" gki_defconfig
               
        echo ""
        echo "‚úÖ Kernel configured successfully"
        echo "   Configuration summary:"
        echo "   - SUSFS: 2.0.0 (auto-hook)"
        echo "   - Optimization: ${{ inputs.optimize_level }}"
        echo "   - ZRAM: ${{ inputs.enable_zram }}"
        echo "   - LSM (BBG): $ENABLE_LSM"
        echo "   - Scheduler: ${{ inputs.sched }}"
        echo "   - KUnit tests: disabled"
        
        echo "::endgroup::"        

    - name: Customize Kernel Branding
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Customize kernel branding"
        KERNEL_PATH="$GITHUB_WORKSPACE/$CONFIG/kernel_platform"
        cd "$KERNEL_PATH/common"
        mkdir -p out
        CUSTOM_LOCALVERSION="-${{ env.ANDROID_VER }}-OP-UltraBolt"
        echo "CUSTOM_LOCALVERSION=$CUSTOM_LOCALVERSION" >> "$GITHUB_ENV"
        echo "‚úÖ Kernel branding: $CUSTOM_LOCALVERSION"
        echo "::endgroup::"

    - name: Build Kernel
      shell: bash
      env:
        PYTHONWARNINGS: "ignore:invalid escape sequence"
      run: |
        set -euo pipefail
        echo "::group::Build kernel with ccache"
        
        KERNEL_PATH="$GITHUB_WORKSPACE/$CONFIG/kernel_platform"
        COMMON="$KERNEL_PATH/common"
        cd "$COMMON"
        : > "$COMMON/.scmversion"
        
        export PYTHONWARNINGS="${PYTHONWARNINGS}"
        
        # Get commit info
        COMMIT_TIMESTAMP=$(git log -1 --format=%ct 2>/dev/null || echo "$(date +%s)")
        COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S' 2>/dev/null || date -u '+%Y-%m-%d %H:%M:%S')
        COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        
        export SOURCE_DATE_EPOCH=$COMMIT_TIMESTAMP
        export KBUILD_BUILD_TIMESTAMP="$COMMIT_DATE UTC"
        export KBUILD_BUILD_USER="${BUILD_USER:-builder}"
        export KBUILD_BUILD_HOST="${BUILD_HOST:-github-actions}"
        export KBUILD_BUILD_VERSION=1
        
        # ‚úÖ FIX: Ensure ccache is in PATH first
        export PATH="/usr/lib/ccache:${CLANG_BIN_PATH}:${PATH}"
        
        if [ "${{ inputs.clean }}" = "true" ]; then
          echo "üßπ Clean build mode - ccache disabled"
          export CCACHE_DISABLE=1
        else
          echo "üöÄ ccache-accelerated build"
          # Verify ccache wrapper is working
          if ! command -v ccache >/dev/null 2>&1; then
            echo "::warning::ccache not found in PATH"
          else
            echo "‚úÖ ccache wrapper: $(which clang)"
          fi
        fi
        
        # Compiler flags
        WORKSPACE="${GITHUB_WORKSPACE}"
        MAP="-fdebug-prefix-map=${WORKSPACE}=."
        MPMAP="-fmacro-prefix-map=${WORKSPACE}=."
        FPMAP="-ffile-prefix-map=${WORKSPACE}=."
        
        export KCFLAGS="${KCFLAGS:-} $MAP $MPMAP $FPMAP -no-canonical-prefixes -fdiagnostics-color=never -Qunused-arguments -Wno-unused-command-line-argument"
        export KCPPFLAGS="${KCPPFLAGS:-} $MAP $MPMAP $FPMAP"
        
        # ‚úÖ FIX: Use ccache wrapper explicitly
        if [ "${{ inputs.clean }}" != "true" ]; then
          export CC="ccache clang"
          export CXX="ccache clang++"
          export HOSTCC="ccache clang"
          export HOSTCXX="ccache clang++"
        else
          export CC="clang"
          export CXX="clang++"
          export HOSTCC="clang"
          export HOSTCXX="clang++"
        fi
        
        export LLVM=1 LLVM_IAS=1
        export ARCH=arm64 SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export LD=ld.lld HOSTLD=ld.lld AR=llvm-ar NM=llvm-nm
        export OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip
        
        OUT=out
        mkdir -p "$OUT"
        
        # Calculate optimal job count
        NPROC=$(nproc --all)
        if [ "$NPROC" -le 2 ]; then
          JOBS="$NPROC"
        elif [ "$NPROC" -le 4 ]; then
          JOBS=$((NPROC + 1))
        else
          JOBS=$((NPROC + 2))
        fi
        
        echo "============================================"
        echo "üîß Build Configuration"
        echo "============================================"
        echo "Device: ${OP_MODEL}"
        echo "Kernel: ${KERNEL_FULL_VER}"
        echo "CPU Cores: $NPROC"
        echo "Parallel Jobs: $JOBS"
        echo "Optimization: ${{ inputs.optimize_level }}"
        echo "Compiler: $CC"
        
        if [ "${{ inputs.clean }}" != "true" ]; then
          echo "ccache: ENABLED"
          echo "  Wrapper test: $(which clang 2>/dev/null || echo 'not found')"
          ccache -s | head -n 10
        else
          echo "ccache: DISABLED"
        fi
        echo "============================================"
        
        # Configure kernel
        make O="$OUT" gki_defconfig
        
        if [ -n "${CUSTOM_LOCALVERSION:-}" ]; then
          scripts/config --file "$OUT/.config" --set-str LOCALVERSION "${CUSTOM_LOCALVERSION}"
          scripts/config --file "$OUT/.config" -d LOCALVERSION_AUTO || true
        fi
        
        # Disable KUnit tests
        disable_list=(
          CONFIG_REGMAP_KUNIT
          CONFIG_INPUT_KUNIT_TEST
          CONFIG_SND_SOC_TOPOLOGY_KUNIT_TEST
          CONFIG_HID_KUNIT_TEST
          CONFIG_RTC_LIB_KUNIT_TEST
          CONFIG_CLK_KUNIT_TEST
          CONFIG_IIO_FORMAT_KUNIT_TEST
          CONFIG_EXT4_KUNIT_TESTS
          CONFIG_FAT_KUNIT_TEST
        )
        for sym in "${disable_list[@]}"; do
          scripts/config --file "$OUT/.config" -d "$sym" || true
        done
        
        # Set optimization level
        if [ "${{ inputs.optimize_level }}" = "O3" ]; then
          scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE
          scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE_O3
          KCFLAGS_EXTRA="-O3"
        else
          scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE
          scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE_O3
          KCFLAGS_EXTRA="-O2"
        fi
        
        scripts/config --file "$OUT/.config" -e LTO_CLANG_THIN
        scripts/config --file "$OUT/.config" -e LTO_CLANG
        make O="$OUT" olddefconfig
        
        KCFLAGS="$KCFLAGS -Wno-error -pipe -fno-stack-protector ${KCFLAGS_EXTRA}"
        KCPPFLAGS="$KCPPFLAGS -DCONFIG_OPTIMIZE_INLINING"
        
        # Build
        BUILD_START=$(date +%s)
        set -o pipefail
        
        if ! make -j"$JOBS" O="$OUT" KCFLAGS="$KCFLAGS" KCPPFLAGS="$KCPPFLAGS" 2>&1 | tee build.log; then
          echo "::error::Kernel build failed"
          echo "::group::Last 100 lines of build log"
          tail -n 100 build.log || true
          echo "::endgroup::"
          exit 1
        fi
        
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        
        echo "BUILD_TIME=$BUILD_TIME" >> "$GITHUB_ENV"
        
        # Verify Image
        IMG="$OUT/arch/arm64/boot/Image"
        if [ ! -f "$IMG" ]; then
          echo "::error::Kernel Image not found"
          exit 1
        fi
        
        IMG_SIZE=$(stat -c%s "$IMG")
        
        echo "============================================"
        echo "‚úÖ Build Completed Successfully"
        echo "============================================"
        echo "Duration: $((BUILD_TIME / 60))m $((BUILD_TIME % 60))s"
        echo "Image: $(numfmt --to=iec-i --suffix=B "$IMG_SIZE")"
        
        if [ "${{ inputs.clean }}" != "true" ]; then
          echo ""
          echo "üìä ccache Post-Build Statistics"
          ccache -s
        fi
        echo "============================================"
        echo "::endgroup::"

    - name: üîß Apply KPM patch_linux    
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Apply KPM patch_linux"
        
        KERNEL_PATH="$GITHUB_WORKSPACE/$CONFIG/kernel_platform"
        PATCH_DIR="$GITHUB_WORKSPACE/SukiSU_patch/kpm"
        COMMON_DIR="$KERNEL_PATH/common"
        OUT_DIR="$COMMON_DIR/out"
        
        # ‚úÖ FIX: Verify patch_linux exists
        if [ ! -f "$PATCH_DIR/patch_linux" ]; then
          echo "::error::patch_linux not found at: $PATCH_DIR/patch_linux"
          echo "Available files:"
          ls -la "$PATCH_DIR/" || true
          exit 1
        fi
        
        # ‚úÖ FIX: Verify original Image exists
        ORIGINAL_IMAGE="$OUT_DIR/arch/arm64/boot/Image"
        if [ ! -f "$ORIGINAL_IMAGE" ]; then
          echo "::error::Original kernel Image not found"
          exit 1
        fi
        
        # Create working directory
        FINAL_IMAGE_DIR="$OUT_DIR/Final-Image-Find"
        mkdir -p "$FINAL_IMAGE_DIR"
        
        # Copy files
        cp "$PATCH_DIR/patch_linux" "$FINAL_IMAGE_DIR/"
        cp "$ORIGINAL_IMAGE" "$FINAL_IMAGE_DIR/"
        
        cd "$FINAL_IMAGE_DIR"
        chmod +x patch_linux
        
        # ‚úÖ FIX: Run with better error handling
        echo "üî® Running patch_linux..."
        if ! ./patch_linux 2>&1 | tee patch_linux.log; then
          echo "::error::patch_linux failed"
          echo "::group::patch_linux output"
          cat patch_linux.log || true
          echo "::endgroup::"
          exit 1
        fi
        
        # ‚úÖ FIX: Verify oImage was created
        if [ ! -f "oImage" ]; then
          echo "::error::oImage was not created"
          echo "Files in directory:"
          ls -la
          exit 1
        fi
        
        # Get checksums
        ORIGINAL_SHA256=$(sha256sum Image | awk '{print $1}')
        PATCHED_SHA256=$(sha256sum oImage | awk '{print $1}')
        
        echo ""
        echo "üìä Patch Results:"
        echo "   Original SHA256: $ORIGINAL_SHA256"
        echo "   Patched SHA256:  $PATCHED_SHA256"
        
        # ‚úÖ FIX: Verify patch was actually applied
        if [ "$ORIGINAL_SHA256" = "$PATCHED_SHA256" ]; then
          echo "::warning::SHA256 unchanged - patch may not have been applied"
        else
          echo "‚úÖ Image successfully patched"
        fi
        
        # Replace original with patched
        rm -f Image
        mv oImage Image
        
        # Copy back to build output
        cp Image "$OUT_DIR/arch/arm64/boot/Image"
        
        # Copy to AnyKernel3
        ANYKERNEL_DIR="$GITHUB_WORKSPACE/AnyKernel3"
        if [ -d "$ANYKERNEL_DIR" ]; then
          cp Image "$ANYKERNEL_DIR/Image"
          echo "‚úÖ Patched Image copied to AnyKernel3"
        fi
        
        # Save to environment
        echo "KPM_PATCHED=true" >> "$GITHUB_ENV"
        echo "KPM_IMAGE_SHA256=$PATCHED_SHA256" >> "$GITHUB_ENV"
        
        echo "::endgroup::"

    - name: ccache Statistics
      id: ccache_stats
      if: ${{ always() && inputs.clean != 'true' }}
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::ccache statistics"
        
        STATS="$(ccache -s)"
        echo "$STATS"
        
        CACHEABLE=$(echo "$STATS" | awk '/Cacheable calls:/ {match($0, /[0-9]+/); print substr($0, RSTART, RLENGTH)}' | head -n1)
        HITS=$(echo "$STATS" | awk '/^[[:space:]]*Hits:/ {match($0, /[0-9]+/); print substr($0, RSTART, RLENGTH)}' | head -n1)
        DIRECT=$(echo "$STATS" | awk '/Direct:/ {match($0, /[0-9]+/); print substr($0, RSTART, RLENGTH)}' | head -n1)
        
        if [ "${CACHEABLE:-0}" -gt 0 ]; then
          HIT_RATE=$(awk -v h="${HITS:-0}" -v c="$CACHEABLE" 'BEGIN{printf "%.1f", (h/c)*100}')
          DIRECT_RATE=$(awk -v d="${DIRECT:-0}" -v c="$CACHEABLE" 'BEGIN{printf "%.1f", (d/c)*100}')
        else
          HIT_RATE="0.0"
          DIRECT_RATE="0.0"
        fi
        
        {
          echo "hit_rate=${HIT_RATE}%"
          echo "direct_rate=${DIRECT_RATE}%"
        } >> "$GITHUB_OUTPUT"
        
        echo ""
        echo "üìä Cache Performance:"
        echo "   Hit Rate: ${HIT_RATE}%"
        echo "   Direct Rate: ${DIRECT_RATE}%"
        
        # Cleanup old cache entries
        ccache -M 3G
        ccache --evict-older-than 7d || true
        
        echo "::endgroup::"

    - name: üìä Collect build statistics
      id: collect_stats
      if: always()
      shell: bash
      run: |
        set -euo pipefail
        IFS=$'\n\t'
        echo "::group::Collect build statistics"
        
        KERNEL_PATH="$GITHUB_WORKSPACE/$CONFIG/kernel_platform"
        IMG="$KERNEL_PATH/common/out/arch/arm64/boot/Image"
        
        if [ ! -f "$IMG" ]; then
          echo "::error::Kernel Image not found at: $IMG"
          exit 1
        fi
        
        IMAGE_SHA256=$(sha256sum "$IMG" | awk '{print $1}')
        IMAGE_SIZE=$(stat -c%s "$IMG")
        IMAGE_SIZE_MB=$(awk -v s="$IMAGE_SIZE" 'BEGIN{printf "%.2f", s/1024/1024}')
        
        WARNINGS=0
        ERRORS=0
        if [ -f "$KERNEL_PATH/common/build.log" ]; then
          WARNINGS=$(grep -F -c "warning:" "$KERNEL_PATH/common/build.log" 2>/dev/null || true)
          ERRORS=$(grep -F -c "error:" "$KERNEL_PATH/common/build.log" 2>/dev/null || true)
          WARNINGS=${WARNINGS:-0}
          ERRORS=${ERRORS:-0}
        fi
        
        if [[ ! "$IMAGE_SHA256" =~ ^[a-f0-9]{64}$ ]]; then
          echo "::error::Invalid SHA256 format"
          exit 1
        fi
        
        {
          echo "image_sha256=$IMAGE_SHA256"
          echo "image_size=$IMAGE_SIZE"
          echo "image_size_mb=$IMAGE_SIZE_MB"
          echo "build_time=${BUILD_TIME:-0}"
          echo "warnings_count=$WARNINGS"
          echo "errors_count=$ERRORS"
        } >> "$GITHUB_OUTPUT"
        
        echo ""
        echo "üìä Build Statistics:"
        echo "   Image SHA256: $IMAGE_SHA256"
        echo "   Image Size: ${IMAGE_SIZE_MB} MB"
        
        if [ "${BUILD_TIME:-0}" -gt 0 ]; then
          echo "   Build Time: $((BUILD_TIME / 60))m $((BUILD_TIME % 60))s"
        else
          echo "   Build Time: N/A"
        fi
        
        if [ "${WARNINGS}" -eq 0 ]; then
          echo "   Compiler Warnings: ‚úÖ None"
        else
          echo "   Compiler Warnings: ‚ö†Ô∏è ${WARNINGS} found"
        fi
        
        if [ "${ERRORS}" -eq 0 ]; then
          echo "   Build Errors: ‚úÖ None"
        else
          echo "   Build Errors: ‚ùå ${ERRORS} found"
        fi
        
        echo "::endgroup::"
        
    - name: Download and Package ZRAM Module
      id: zram_module
      if: ${{ inputs.enable_zram == 'true' }}
      continue-on-error: true
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Download ZRAM module"
            
        mkdir -p "${ARTIFACTS_DIR}"
            
        KERNEL_VER="${{ env.KERNEL_VER }}"
        ANDROID_VER="${{ env.ANDROID_VER }}"
            
        ZRAM_BASE_URL="https://github.com/Numbersf/Action-Build/releases/download/zram-modules"
            
        case "$KERNEL_VER" in
          5.10)
            download_url="$ZRAM_BASE_URL/zram-${ANDROID_VER}-5.10.tar.gz"
            ;;
          5.15)
            download_url="$ZRAM_BASE_URL/zram-${ANDROID_VER}-5.15.tar.gz"
            ;;
          6.1)
            download_url="$ZRAM_BASE_URL/zram-${ANDROID_VER}-6.1.tar.gz"
            ;;
          6.6)
            download_url="$ZRAM_BASE_URL/zram-${ANDROID_VER}-6.6.tar.gz"
            ;;
          6.12)
            download_url="$ZRAM_BASE_URL/zram-${ANDROID_VER}-6.12.tar.gz"
            ;;
          *)
            echo "::warning::ZRAM module not available for kernel $KERNEL_VER"
            echo "zram_available=false" >> "$GITHUB_OUTPUT"
            echo "::endgroup::"
            exit 0
            ;;
        esac
            
        echo "Downloading ZRAM module from: $download_url"
          
        success=0
        if [ -n "$download_url" ]; then
          if wget -N "$download_url" -O "${ARTIFACTS_DIR}/zram-module.tar.gz" 2>&1 | tee /tmp/wget.log; then
            if [ -f "${ARTIFACTS_DIR}/zram-module.tar.gz" ]; then
              cd "${ARTIFACTS_DIR}"
              if tar -xzf zram-module.tar.gz; then
                rm -f zram-module.tar.gz
                success=1
                echo "‚úÖ ZRAM module downloaded and extracted"
              else
                echo "::warning::Failed to extract ZRAM module"
              fi
            fi
           else
            echo "::warning::wget failed for $download_url"
            cat /tmp/wget.log || true
          fi
        fi
            
        if [ "$success" = "1" ]; then
          echo "zram_available=true" >> "$GITHUB_OUTPUT"
        else
          echo "zram_available=false" >> "$GITHUB_OUTPUT"
        fi
            
        echo "::endgroup::"

    - name: Create Flashable ZIP
      id: create_zip
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Create flashable ZIP"
        
        KERNEL_PATH="$GITHUB_WORKSPACE/$CONFIG/kernel_platform"
        IMG="$KERNEL_PATH/common/out/arch/arm64/boot/Image"
        ANYKERNEL_DIR="$GITHUB_WORKSPACE/AnyKernel3"
        
        if [ ! -f "$IMG" ]; then
          echo "::error::Kernel Image not found"
          exit 1
        fi
        
        if [ ! -d "$ANYKERNEL_DIR" ]; then
          echo "::error::AnyKernel3 directory not found"
          exit 1
        fi
        
        cd "$ANYKERNEL_DIR"
        cp "$IMG" ./
        
        if [ "${{ inputs.enable_zram }}" = "true" ] && [ "${{ steps.zram_module.outputs.zram_available }}" = "true" ]; then
          echo "Including ZRAM modules..."
          if [ -d "${ARTIFACTS_DIR}/modules" ]; then
            mkdir -p ./modules
            cp -r "${ARTIFACTS_DIR}/modules/"* ./modules/ || true
            echo "‚úÖ ZRAM modules included"
          else
            echo "‚ö†Ô∏è ZRAM modules directory not found"
          fi
        fi
        
        KERNEL_VERSION="${{ env.KERNEL_FULL_VER }}"
        DEVICE_MODEL="${{ env.OP_MODEL }}"
        
        SUFFIX=""
        [ "${{ inputs.enable_zram }}" = "true" ] && SUFFIX="${SUFFIX}_LZ4KD"
        [ "${{ inputs.lsm }}" = "true" ] && SUFFIX="${SUFFIX}_LSM"
        [ "${{ inputs.sched }}" = "true" ] && SUFFIX="${SUFFIX}_SCHED"
        
        ZIP_NAME="SukiSU-Ultra-${DEVICE_MODEL}-${KERNEL_VERSION}${SUFFIX}.zip"
        
        echo "Creating ZIP: $ZIP_NAME"
        echo "Compression: deflate (level 9)"
        
        # ‚úÖ FIX: Use standard deflate compression
        if ! zip -r9 "$ZIP_NAME" . \
             -x ".git*" \
             -x ".github/*" \
             -x "README.md" \
             -x "LICENSE" \
             -x "$ZIP_NAME" 2>&1 | tee /tmp/zip.log; then
          echo "::error::ZIP creation failed"
          cat /tmp/zip.log
          exit 1
        fi
        
        if [ ! -f "$ZIP_NAME" ]; then
          echo "::error::ZIP file not created"
          ls -lah
          exit 1
        fi
        
        ZIP_SIZE=$(stat -c%s "$ZIP_NAME")
        ZIP_SIZE_MB=$(awk -v s="$ZIP_SIZE" 'BEGIN{printf "%.2f", s/1024/1024}')
        ZIP_SHA256=$(sha256sum "$ZIP_NAME" | awk '{print $1}')
        
        mv "$ZIP_NAME" "${ARTIFACTS_DIR}/"
        
        {
          echo "zip_name=${ZIP_NAME}"
          echo "zip_path=${ARTIFACTS_DIR}/${ZIP_NAME}"
          echo "zip_size=${ZIP_SIZE}"
          echo "zip_size_mb=${ZIP_SIZE_MB}"
          echo "zip_sha256=${ZIP_SHA256}"
        } >> "$GITHUB_OUTPUT"
        
        echo "‚úÖ Flashable ZIP created"
        echo "   Name: ${ZIP_NAME}"
        echo "   Size: ${ZIP_SIZE_MB} MB"
        echo "   SHA256: ${ZIP_SHA256}"
        
        echo "::endgroup::"

    - name: Save Metadata
      id: save_metadata
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Save build metadata"
        
        cat > "${ARTIFACTS_DIR}/build_info.json" << EOF
        {
          "device": "${OP_MODEL}",
          "soc": "${OP_SOC}",
          "kernel_version": "${KERNEL_FULL_VER}",
          "android_version": "${ANDROID_VER}",
          "sukisu_version": "${SUKISUVER}",
          "susfs_version": "${SUSVER:-2.0.0}",
          "clang_version": "${CLANG_VERSION_SHORT}",
          "build_date": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')",
          "build_time_seconds": ${BUILD_TIME:-0},
          "optimization": "${{ inputs.optimize_level }}",
          "hook_type": "auto",
          "lsm_enabled": ${{ inputs.lsm }},
          "zram_enabled": ${{ inputs.enable_zram }},
          "scheduler": "${{ inputs.sched }}",
          "zip_name": "${{ steps.create_zip.outputs.zip_name }}",
          "zip_sha256": "${{ steps.create_zip.outputs.zip_sha256 }}",
          "image_sha256": "${{ steps.collect_stats.outputs.image_sha256 }}"
        }
        EOF
        
        {
          echo "kernel_version=${KERNEL_FULL_VER}"
          echo "sukisu_version=${SUKISUVER:-0}"
          echo "susfs_version=${SUSVER:-2.0.0}"
        } >> "$GITHUB_OUTPUT"
        
        echo "‚úÖ Metadata saved to build_info.json"
        cat "${ARTIFACTS_DIR}/build_info.json"
        
        echo "::endgroup::"

    - name: Generate Build Summary
      if: always()
      shell: bash
      run: |
        set -euo pipefail
        
        echo "# üéâ Kernel Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "## ‚úÖ Build Successful" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ‚ùå Build Failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## üì± Device Information" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Device | ${OP_MODEL} |" >> $GITHUB_STEP_SUMMARY
        echo "| SoC | ${OP_SOC} |" >> $GITHUB_STEP_SUMMARY
        echo "| Kernel | ${KERNEL_FULL_VER:-unknown} |" >> $GITHUB_STEP_SUMMARY
        echo "| Android | ${ANDROID_VER:-unknown} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## üîß Build Configuration" >> $GITHUB_STEP_SUMMARY
        echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| SukiSU Version | v${SUKISUVER:-unknown} |" >> $GITHUB_STEP_SUMMARY
        echo "| SUSFS Version | ${SUSVER:-2.0.0} |" >> $GITHUB_STEP_SUMMARY
        echo "| Clang | ${CLANG_VERSION_SHORT:-unknown} |" >> $GITHUB_STEP_SUMMARY
        echo "| Optimization | ${{ inputs.optimize_level }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Hook Type | Auto (SUSFS 2.0) |" >> $GITHUB_STEP_SUMMARY
        echo "| LSM (BBG) | ${{ inputs.lsm }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ZRAM | ${{ inputs.enable_zram }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Scheduler | ${{ inputs.sched }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "## üì¶ Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ZIP Name | ${{ steps.create_zip.outputs.zip_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ZIP Size | ${{ steps.create_zip.outputs.zip_size_mb }} MB |" >> $GITHUB_STEP_SUMMARY
          echo "| ZIP SHA256 | \`${{ steps.create_zip.outputs.zip_sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image SHA256 | \`${{ steps.collect_stats.outputs.image_sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.enable_zram }}" = "true" ]; then
            if [ "${{ steps.zram_module.outputs.zram_available }}" = "true" ]; then
              echo "| ZRAM Module | ‚úÖ Included |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ZRAM Module | ‚ö†Ô∏è Not available |" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        echo "## ‚è±Ô∏è Build Performance" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "${BUILD_TIME:-}" ]; then
          BUILD_MIN=$((BUILD_TIME / 60))
          BUILD_SEC=$((BUILD_TIME % 60))
          echo "| Build Time | ${BUILD_MIN}m ${BUILD_SEC}s |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Build Time | N/A |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ inputs.clean }}" != "true" ]; then
          if [ -n "${{ steps.ccache_stats.outputs.hit_rate }}" ]; then
            echo "| ccache Hit Rate | ${{ steps.ccache_stats.outputs.hit_rate }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ccache Direct Rate | ${{ steps.ccache_stats.outputs.direct_rate }} |" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "| ccache | Disabled (clean build) |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "${{ steps.collect_stats.outputs.warnings_count }}" ]; then
          echo "| Warnings | ${{ steps.collect_stats.outputs.warnings_count }} |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "${{ steps.collect_stats.outputs.errors_count }}" ]; then
          echo "| Errors | ${{ steps.collect_stats.outputs.errors_count }} |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## üîç System Resources" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "Disk Usage:" >> $GITHUB_STEP_SUMMARY
        df -h / | tail -n1 >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Memory:" >> $GITHUB_STEP_SUMMARY
        free -h | grep -E "^Mem:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Built with ‚ù§Ô∏è by SukiSU Ultra Action (SUSFS 2.0.0)*" >> $GITHUB_STEP_SUMMARY

    - name: üì§ Upload kernel artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.OP_MODEL }}-${{ env.ANDROID_VER }}
        path: ${{ env.ARTIFACTS_DIR }}
        retention-days: 30
        if-no-files-found: error
        compression-level: 6


